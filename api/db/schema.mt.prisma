datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = "native"
}

model User {
  id                String       @id @default(cuid())
  email             String       @unique
  hashedPassword    String
  salt              String
  firstName         String?
  lastName          String?
  phoneNumber       String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  memberships       Membership[]
  globalSettings    Json? // User's global preferences
  assignment        Assignment[]
  event             Event[]
  lastLoginAt       DateTime?
  loginAttempts     Int          @default(0)
  isLocked          Boolean      @default(false)
  passwordChangedAt DateTime?
  media             Media[]
}

model Organization {
  id               String       @id @default(cuid())
  name             String
  createdAt        DateTime     @default(now())
  members          Membership[]
  sites            Site[]
  settings         Json? // Stores settings specific to the organization
  billingEmail     String?
  stripeCustomerId String?
  Inspection       Inspection[]
  Event            Event[]
}

model Membership {
  id                  String           @id @default(cuid())
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String
  organization        Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId      String
  roles               MembershipRole[]
  settings            Json? // Per-organization user-specific settings
  status              MembershipStatus
  invitationId        String?
  invitedEmail        String?
  invitationExpiresAt DateTime?
  invitedAt           DateTime?
  joinedAt            DateTime?
  invitationAttempts  Int              @default(0)
  lastInvitationSent  DateTime?

  invitationChannel InvitationChannel
  assignment        Assignment[]
  event             Event[]
  media             Media[]

  @@unique([userId, organizationId])
  @@unique([invitationId, organizationId])
}

model MembershipRole {
  id           String       @id @default(cuid())
  name         String       @unique
  membership   Membership[]
  permission   Permission?  @relation(fields: [permissionId], references: [id])
  permissionId String?
  site         Site?        @relation(fields: [siteId], references: [id])
  siteId       String?
}

model Permission {
  id             String           @id @default(cuid())
  name           String           @unique
  description    String?
  membershipRole MembershipRole[]
}

enum InvitationChannel {
  EMAIL
  SLACK
  INTERNAL
  EXTERNAL
}

enum MembershipStatus {
  INVITED
  ACTIVE
  SUSPENDED
  PENDING
}

model Site {
  id             String       @id @default(cuid())
  name           String
  deletedAt      DateTime?
  isArchived
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  metadata       Json?
  currentData    Json?
  assignments    Assignment[]
  events         Event[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  Inspection     Inspection[]

  @@index([deletedAt])
}

model Assignment {
  id           String      @id @default(cuid())
  site         Site        @relation(fields: [siteId], references: [id])
  siteId       String
  user         User?       @relation(fields: [userId], references: [id])
  userId       String
  membership   Membership? @relation(fields: [membershipId], references: [id])
  membershipId String

  @@unique([userId, siteId])
}

model Event {
  id             String       @id @default(cuid())
  type           EventType
  site           Site         @relation(fields: [siteId], references: [id])
  siteId         String
  membership     Membership   @relation(fields: [membershipId], references: [id])
  membershipId   String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  details        Json?
  createdAt      DateTime     @default(now())
  media          Media[]
  metadata       Json?

  inspectionEventDetails InspectionEventDetails?
  inspection             Inspection?             @relation(fields: [inspectionId], references: [id])
  inspectionId           String?
  eventTag               EventTag[]
  user                   User?                   @relation(fields: [userId], references: [id])
  userId                 String?

  @@index([organizationId, type, createdAt])
  @@index([membershipId, type])
  @@index([siteId, createdAt])
}

model EventTag {
  id      String @id @default(cuid())
  eventId String
  tag     String
  event   Event  @relation(fields: [eventId], references: [id])

  @@unique([eventId, tag]) // Prevent duplicate tagging.
}

model InspectionEventDetails {
  id           String @id @default(cuid())
  statusChange Json?
  event        Event  @relation(fields: [eventId], references: [id])
  eventId      String @unique
}

enum EventType {
  INSPECTION_CREATED
  INSPECTION_UPDATED
  BMP_ADDED
  BMP_UPDATED
  SITE_CREATED
  SITE_UPDATED
  MEDIA_UPLOADED
}

model Inspection {
  id             String       @id @default(cuid())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  site           Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId         String
  events         Event[] // Linked events
  currentState   Json? // Reflects the latest state of the inspection
  media          Media[]

  @@index([organizationId, siteId])
}

model Media {
  id           String     @id @default(cuid())
  url          String
  description  String?
  inspection   Inspection @relation(fields: [inspectionId], references: [id])
  inspectionId String?
  siteId       String?
  event        Event?     @relation(fields: [eventId], references: [id])
  eventId      String?
  type         MediaType
  fileSize     Int?
  mimeType     String?
  uploadedBy   Membership @relation(fields: [membershipId], references: [id])
  membershipId String
  user         User?      @relation(fields: [userId], references: [id])
  userId       String?

  @@index([inspectionId])
}

enum MediaType {
  IMAGE
  DOCUMENT
  VIDEO
  AUDIO
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String
  changes      Json?
  createdAt    DateTime @default(now())
}
